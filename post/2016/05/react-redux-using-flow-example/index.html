<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=0.9"><title>静的型チェッカーflowでReact&#43;Reduxのサンプルアプリを組んでみた - Namiking.net</title><link rel="stylesheet" href="/css/bundle.css"><script src="/js/bundle.js"></script></head><body><div class="layout-sitenavi"><div class="container"><div class="layout-sitenavi__title"><a href="http://blog.namiking.net/"><strong>Namiking.net</strong><p>Web系エンジニアの技術ブログ</p></a></div><div class="layout-sitenavi__menu"><ul><li><a href="http://blog.namiking.net/about/"><i class="fa fa-lg fa-user"></i><span>ABOUT</span></a></li><li><a href="https://github.com/namikingsoft/"><i class="fa fa-lg fa-github"></i><span>GITHUB</span></a></li><li><a href="https://twitter.com/namikingsoft/"><i class="fa fa-lg fa-twitter"></i><span>TWITTER</span></a></li></ul></div></div></div><div class="layout-headline-single"><div class="container"><header><div class="layout-headline-single__title"><h1>静的型チェッカーflowでReact&#43;Reduxのサンプルアプリを組んでみた</h1></div><div class="lead"><div class="layout-headline-single__meta"><ul><li><i class="fa fa-calendar"></i>2016-05-22 (Sun)</li><li><img src="https://s.gravatar.com/avatar/3706c1a344dc2282c6683b6c6d0926f2?s=27&r=g">namikingsoft</li></ul></div><div class="layout-headline-single__taxonomies"><ul><li><a class="label label-success" href="/categories/%E9%9D%99%E7%9A%84%E5%9E%8B%E4%BB%98%E3%81%91%E8%A8%80%E8%AA%9E">静的型付け言語</a></li><li><a class="label label-default" href="/tags/javascript">JavaScript</a></li><li><a class="label label-default" href="/tags/ecmascript">ECMAScript</a></li><li><a class="label label-default" href="/tags/flow">flow</a></li><li><a class="label label-default" href="/tags/flowtype">flowtype</a></li><li><a class="label label-default" href="/tags/react">React</a></li><li><a class="label label-default" href="/tags/redux">Redux</a></li></ul></div></div></header></div></div><div class="layout-content"><div class="container"><article><div class="layout-content__body"><div class="module-markdown">

<p>JavaScript型チェッカー<a href="http://flowtype.org/">flow</a>を使って、React+Reduxで簡単なカウンターのサンプルアプリケーションを組んでみたので、その際のいくつかのポイントなどをまとめておきます。</p>

<h3 id="サンプルアプリについて">サンプルアプリについて</h3>

<p>ボタンを押したら数字がインクリメントされるタイプのよくあるサンプルプログラム。</p>

<p><img src="/images/post/2016/05/react-redux-flow-sample/preview.gif" alt="サンプルアプリPreview" /></p>

<blockquote>
<p>GitHub: namikingsoft/react-redux-using-flow-example
<a href="https://github.com/namikingsoft/react-redux-using-flow-example">https://github.com/namikingsoft/react-redux-using-flow-example</a></p>
</blockquote>

<p>非同期周りの処理に<a href="https://github.com/yelouafi/redux-saga">redux-saga</a>を使ってますが、今回はその辺りの解説は省きます。</p>

<h2 id="ポイントいくつか">ポイントいくつか</h2>

<p>サンプルアプリ実装の際に、工夫した点/苦労した点を以下にまとめておきました。</p>

<h3 id="stateやactionの型定義をする">StateやActionの型定義をする</h3>

<p>ReduxのStateやActionのPayload値は、動的言語らしく何でも入れる事が可能です。一人で開発するのなら良いですが、複数人で開発する場合、<strong>Action-&gt;Reducer-&gt;Viewで引き回す型の認識が合わず、思わぬバグが発生</strong>しかねません。</p>

<p>なるべく一つの型定義を使いまわし、値の引き回しに規約を与える必要があります。</p>

<h4 id="fluxスタンダードなaction型の定義">FluxスタンダードなAction型の定義</h4>

<pre><code class="language-typescript">// src/types/Action.js
export interface Action {
  type: string;
  error?: boolean;
  meta?: any;
}

export interface PayloadAction&lt;T&gt; extends Action {
  payload: T;
}
</code></pre>

<p>Action関数が返すべきオブジェクトの型定義をします。</p>

<blockquote>
<p>GitHub: acdlite/flux-standard-action<br />
<a href="https://github.com/acdlite/flux-standard-action">https://github.com/acdlite/flux-standard-action</a></p>
</blockquote>

<p>非公式ではありますが、HumanフレンドリーなAction型として定評のあるFluxスタンダードに沿う形のAction型を組みました。</p>

<p>個人的に、PayloadがあるActionとないActionとで、型を分けたかったので、分離してあります。Payloadに使う型は以下項目のように、ジェネリクスで指定できます。</p>

<h4 id="counter関連の型を定義する">Counter関連の型を定義する</h4>

<pre><code class="language-typescript">// src/types/Counter.js
import type { Action, PayloadAction } from &quot;types/Action&quot;

export interface CounterState {
  num: number;
}

export interface IncrementPayload {
  num: number;
}

export interface IncrementAction extends PayloadAction&lt;IncrementPayload&gt; {}
export interface ResetAction extends Action {}
export type CounterAction = IncrementAction &amp; ResetAction
</code></pre>

<p>StateやActionの型を一つのファイルに定義しておきます。</p>

<h3 id="定義した型をactionやreducerで使い回す">定義した型をActionやReducerで使い回す</h3>

<p>上で定義した共通の型設定をAction関数やReducer関数で読み込みます。</p>

<h4 id="action関数の定義で使い回す">Action関数の定義で使い回す</h4>

<pre><code class="language-typescript">// src/actions/counter.js
import type { IncrementAction, ResetAction } from &quot;types/Counter&quot;

export const REQUEST_INCREMENT = &quot;COUNTER__REQUEST_INCREMENT&quot;
export const EXECUTE_INCREMENT = &quot;COUNTER__EXECUTE_INCREMENT&quot;
export const RESET = &quot;COUNTER__RESET&quot;

export function requestIncrement(num: number): IncrementAction {
  return { type: REQUEST_INCREMENT, payload: { num } }
}

export function executeIncrement(num: number): IncrementAction {
  return { type: EXECUTE_INCREMENT, payload: { num } }
}

export function reset(): ResetAction {
  return { type: RESET }
}
</code></pre>

<p><code>src/types/Counter.js</code>で定義したものを返り値の型として使いまわしています。Action関数ごとに型定義をするかしないかは、個人の好みとなります。</p>

<h4 id="reducer関数の定義で使い回す">Reducer関数の定義で使い回す</h4>

<pre><code class="language-typescript">import { EXECUTE_INCREMENT, RESET } from &quot;actions/counter&quot;
import type { CounterState, CounterAction } from &quot;types/Counter&quot;

export const initialState: CounterState = { num: 0 }

export default function counter(
  state: CounterState = initialState,
  action: CounterAction,
): CounterState {
  switch (action.type) {
    case EXECUTE_INCREMENT: {
      return { num: state.num + action.payload.num }
    }
    case RESET: {
      return { ...initialState }
    }
    default: {
      return state
    }
  }
}
</code></pre>

<p>Actionで使っている<code>CounterAction</code>は全てのAction関数の返り値型をIntersectionした型です。</p>

<pre><code class="language-typescript">export type CounterAction = IncrementAction &amp; ResetAction
</code></pre>

<p>以下のように、Unionにしてもよいのですが、</p>

<pre><code class="language-typescript">export type CounterAction = IncrementAction | ResetAction
</code></pre>

<p>payloadキーが存在するかしないか、逐一チェックする必要があるため、めんどうです。</p>

<pre><code class="language-typescript">case EXECUTE_INCREMENT: {
  const incrementNum = action.payload ? action.payload.num || 0 : 0
  return { num: state.num + incrementNum }
}
</code></pre>

<h3 id="コンポーネントのprops型はプロパティ変数で定義">コンポーネントのProps型はプロパティ変数で定義</h3>

<p><code>props</code>というプロパティ変数に型をつけることで、ReactのPropTypesのようなチェックをできます。PropTypesは定義方法(isRequredとか)が独特な点、ランタイムエラーしかでない点で、個人的には使いづらい印象でした。</p>

<p>flowの<code>props</code>プロパティを利用すれば、実行前の型チェック時にエラーが出るため、見逃しづらいのと、型定義もflowと同様な方法でできるので、統一感が出ます。</p>

<h4 id="コンポーネントのプロパティ変数でpropsの型定義ができる">コンポーネントのプロパティ変数でPropsの型定義ができる</h4>

<pre><code class="language-typescript">// src/pages/CounterPage.js を改変
class CounterPage extends Component {
  props: {
    counter: CounterState, // クラス型やオブジェクト型も指定しやすい
    dispatch: (action: Action) =&gt; any, // 関数型も定義可能
    num?: number, // 任意項目については、プロパティ名後ろに`?`をつける
  };
  // ...
  render() {
    const { counter } = this.props // connectしたCounterState型
    const { hoge } = this.props // Err! 未定義のプロパティは取り出せない
    // ...
  }
}
</code></pre>

<pre><code class="language-typescript">// 使う側の例
render() {
  return &lt;CounterPage num=&quot;String&quot; /&gt; // Err! 型に合わないプロパティは設定できない
}
</code></pre>

<h3 id="コンポーネント内で使うactionはconnectしない">コンポーネント内で使うActionはconnectしない</h3>

<p><code>react-redux</code>のconnectで、Action関数をpropsに関連付けてしまうと、コンポーネントのPropsで、Action関数の型を再定義する必要があります。</p>

<p>それは面倒＆冗長なので、直接Action関数を使い、その返り値をdispatchすれば、Action関数の元の型定義を使いまわせます。</p>

<h4 id="dispatch関数を直接propsに回す">dispatch関数を直接propsに回す</h4>

<pre><code class="language-typescript">// src/pages/CounterPage.js
export default connect(
  ({ counter }) =&gt; ({ counter }),
  dispatch =&gt; ({ dispatch }), // ここ
)(CounterPage)
</code></pre>

<h4 id="action関数をconnectを通さないことで-元の型定義のまま使える">action関数をconnectを通さないことで、元の型定義のまま使える</h4>

<pre><code class="language-typescript">// src/pages/CounterPage.js
import * as actions from &quot;actions/counter&quot;
</code></pre>

<pre><code class="language-typescript">handlePressIncrement() {
  const { dispatch } = this.props
  dispatch(actions.executeIncrement(1)) // ここ
}
</code></pre>

<h2 id="まとめ">まとめ</h2>

<ul>
<li>StateやActionの型定義をする</li>
<li>定義した型をActionやReducerで使い回す</li>
<li>コンポーネントのProps型はプロパティ変数で定義</li>
<li>コンポーネント内で使うActionはconnectしない</li>
</ul>

<p>React+Reduxでflowを使った型定義の方法をまとめました。今回はあまり使いませんでしたが、業務ドメイン関係の型定義(ActionのPayloadやStateの中で使う型)は、Reduxなどのフレームワークに依存せず、別フレームワークでも使いまわせる可能性があるので、積極的に型定義をしていきたいです。</p>
</div></div><div class="layout-content__comment"><div class="module-comment"><div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'namikingsoft';
    var disqus_identifier = 'http:\/\/blog.namiking.net\/post\/2016\/05\/react-redux-using-flow-example\/';
    var disqus_title = '静的型チェッカーflowでReact\x2bReduxのサンプルアプリを組んでみた';
    var disqus_url = 'http:\/\/blog.namiking.net\/post\/2016\/05\/react-redux-using-flow-example\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div></article></div></div><div class="layout-pagenavi"><div class="container"><div class="layout-pagenavi__relate"><div class="module-relate"><h3>同じシリーズの記事</h3><ul><li>静的型チェッカーflowでReact&#43;Reduxのサンプルアプリを組んでみた</li><li><a href="/post/2016/05/flow-class-private-fields/">静的型チェッカーflowのクラスでPrivateなフィールドを定義するメモ</a></li><li><a href="/post/2016/05/flow-disadvantage/">静的型チェッカーflowを使ってみて、微妙に気になったこと４つ</a></li></ul></div></div><div class="layout-pagenavi__paging"><div class="module-paging"><div class="module-paging__prev col-xs-6"></div><div class="module-paging__next col-xs-6"><a href="/post/2016/05/flow-class-private-fields/" title="静的型チェッカーflowのクラスでPrivateなフィールドを定義するメモ"><i class="fa fa-arrow-circle-o-right"></i><p class="hidden-xs">2016-05-12 (Thu)</p></a></div></div></div></div></div><div class="layout-sharenavi"><div class="container"><h4>この記事について</h4><div class="layout-sharenavi__profile"><div class="module-profile"><div class="module-profile__avatar"><img src="https://s.gravatar.com/avatar/3706c1a344dc2282c6683b6c6d0926f2?s=80&r=g"><small>書いた人<br>Written by</small></div><div class="module-profile__text"><h3>namikingsoft</h3><p>何かを残して逝きたい<br>フロントエンドエンジニア</p><ul><li><a href="http://blog.namiking.net/about/"><i class="fa fa-2x fa-user"></i></a></li><li><a href="https://github.com/namikingsoft/"><i class="fa fa-2x fa-github"></i></a></li><li><a href="https://twitter.com/namikingsoft/"><i class="fa fa-2x fa-twitter"></i></a></li></ul></div></div></div><div class="layout-sharenavi__sharelink"><div class="module-sharelink"><ul class="module-sharelink__list"><li class="module-sharelink__list-twitter"><a class="twitter-share-button" data-url="http://blog.namiking.net/post/2016/05/react-redux-using-flow-example/" href="https://twitter.com/share" data-lang="ja" data-count="vertical" data-dnt="true">ツイート</a></li><li class="module-sharelink__list-facebook"><div class="fb-like" data-href="http://blog.namiking.net/post/2016/05/react-redux-using-flow-example/" data-layout="box_count" data-action="like" data-show-faces="true" data-share="false"></div></li><li class="module-sharelink__list-google"><div class="g-plusone" data-href="http://blog.namiking.net/post/2016/05/react-redux-using-flow-example/" data-size="tall"></div></li><li class="module-sharelink__list-hatena"><a class="hatena-bookmark-button" href="http://b.hatena.ne.jp/entry/http://blog.namiking.net/post/2016/05/react-redux-using-flow-example/" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border:none;"></a></li><li class="module-sharelink__list-pocket"><a class="pocket-btn" data-save-url="http://blog.namiking.net/post/2016/05/react-redux-using-flow-example/" data-pocket-label="pocket" data-pocket-count="vertical" data-lang="en"></a></li><li class="module-sharelink__list-line"><a href="http://line.me/R/msg/text/?http%3a%2f%2fblog.namiking.net%2fpost%2f2016%2f05%2freact-redux-using-flow-example%2f"><img src="/images/button/linebutton_36x60.png" width="36" height="60" alt="LINEに送る"></a></li></ul><div id="fb-root"></div></div></div></div></div><div class="layout-footer"><div class="container"><div class="layout-footer__poweredby col-sm-4"><div class="module-poweredby"><div class="module-poweredby__title"><a href="http://blog.namiking.net/"><strong>Namiking.net</strong><p>Web系エンジニアの技術ブログ</p></a></div><div class="module-poweredby__menu"><ul><li><a href="http://blog.namiking.net/"><i class="fa fa-lg fa-home"></i><span>HOME</span></a></li><li><a href="http://blog.namiking.net/about/"><i class="fa fa-lg fa-user"></i><span>ABOUT</span></a></li><li><a href="https://github.com/namikingsoft/"><i class="fa fa-lg fa-github"></i><span>GITHUB</span></a></li><li><a href="https://twitter.com/namikingsoft/"><i class="fa fa-lg fa-twitter"></i><span>TWITTER</span></a></li><li><a href="http://blog.namiking.net/index.xml"><i class="fa fa-lg fa-rss"></i><span>RSS</span></a></li></ul></div><div class="module-poweredby__hugo"><p>Designed &amp; Written by <a href="/about">@namikingsoft</a></p><p>Powered by <a href="http://gohugo.io">HUGO</a></p></div></div></div><div class="layout-footer__recent col-sm-4"><div class="module-recent"><h3>Recent Post</h3><dl><dt>2016-05-22 (Sun)</dt><dd><a href="/post/2016/05/react-redux-using-flow-example/">静的型チェッカーflowでReact&#43;Reduxのサンプルアプリを組んでみた</a></dd><dt>2016-05-12 (Thu)</dt><dd><a href="/post/2016/05/flow-class-private-fields/">静的型チェッカーflowのクラスでPrivateなフィールドを定義するメモ</a></dd><dt>2016-05-12 (Thu)</dt><dd><a href="/post/2016/05/flow-disadvantage/">静的型チェッカーflowを使ってみて、微妙に気になったこと４つ</a></dd><dt>2016-02-13 (Sat)</dt><dd><a href="/post/2016/02/react-server-using-webpack/">サーバーサイドReactをwebpackを使って最小構成で試す (ES6 ＆ TypeScript)</a></dd><dt>2016-01-31 (Sun)</dt><dd><a href="/post/2016/01/spark-mllib-regression/">Sparkで機械学習： 回帰モデルで値を予測する</a></dd></dl></div></div><div class="layout-footer__tagcloud col-sm-4"><div class="module-tagcloud"><h3>Tags</h3><ul><li><a href="/tags/ddd">ddd(1)</a></li><li><a href="/tags/digitalocean">digitalocean(1)</a></li><li><a href="/tags/docker">docker(9)</a></li><li><a href="/tags/docker-compose">docker-compose(1)</a></li><li><a href="/tags/ecmascript">ecmascript(4)</a></li><li><a href="/tags/eslint">eslint(1)</a></li><li><a href="/tags/express">express(1)</a></li><li><a href="/tags/flow">flow(3)</a></li><li><a href="/tags/flowtype">flowtype(3)</a></li><li><a href="/tags/javascript">javascript(3)</a></li><li><a href="/tags/libreboard">libreboard(1)</a></li><li><a href="/tags/mocha">mocha(1)</a></li><li><a href="/tags/oss">oss(4)</a></li><li><a href="/tags/react">react(2)</a></li><li><a href="/tags/redux">redux(1)</a></li><li><a href="/tags/restyaboard">restyaboard(2)</a></li><li><a href="/tags/softether">softether(1)</a></li><li><a href="/tags/spark">spark(2)</a></li><li><a href="/tags/swarm">swarm(4)</a></li><li><a href="/tags/taiga">taiga(2)</a></li><li><a href="/tags/terraform">terraform(1)</a></li><li><a href="/tags/tls">tls(1)</a></li><li><a href="/tags/typescript">typescript(1)</a></li><li><a href="/tags/vpn">vpn(1)</a></li><li><a href="/tags/webpack">webpack(2)</a></li><li><a href="/tags/webpack-dev-server">webpack-dev-server(1)</a></li><li><a href="/tags/wekan">wekan(2)</a></li><li><a href="/tags/zeppelin">zeppelin(1)</a></li><li><a href="/tags/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9">インフラ(2)</a></li><li><a href="/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92">機械学習(1)</a></li><li><a href="/tags/%E6%B1%BA%E5%AE%9A%E6%9C%A8%E5%9B%9E%E5%B8%B0">決定木回帰(1)</a></li><li><a href="/tags/%E7%B7%9A%E5%BD%A2%E5%9B%9E%E5%B8%B0">線形回帰(1)</a></li></ul></div></div></div></div></body></html>