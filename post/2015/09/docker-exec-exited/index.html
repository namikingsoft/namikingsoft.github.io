<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=0.9"><title>Dockerイメージのビルド中にExitedしたコンテナに入る方法 - Namiking.net</title><link rel="stylesheet" href="/css/bundle.css"><script src="/js/bundle.js"></script></head><body><div class="layout-sitenavi"><div class="container"><div class="layout-sitenavi__title"><a href="http://blog.namiking.net/"><strong>Namiking.net</strong><p>Web系エンジニアの技術ブログ</p></a></div><div class="layout-sitenavi__menu"><ul><li><a href="http://blog.namiking.net/about/"><i class="fa fa-lg fa-user"></i><span>ABOUT</span></a></li><li><a href="https://github.com/namikingsoft/"><i class="fa fa-lg fa-github"></i><span>GITHUB</span></a></li><li><a href="https://twitter.com/namikingsoft/"><i class="fa fa-lg fa-twitter"></i><span>TWITTER</span></a></li></ul></div></div></div><div class="layout-headline-single"><div class="container"><header><div class="layout-headline-single__title"><h1>Dockerイメージのビルド中にExitedしたコンテナに入る方法</h1></div><div class="lead"><div class="layout-headline-single__meta"><ul><li><i class="fa fa-calendar"></i>2015-09-29 (Tue)</li><li><img src="https://s.gravatar.com/avatar/3706c1a344dc2282c6683b6c6d0926f2?s=27&r=g">namikingsoft</li></ul></div><div class="layout-headline-single__taxonomies"><ul><li><a class="label label-success" href="/categories/docker%E9%96%A2%E9%80%A3">Docker関連</a></li><li><a class="label label-default" href="/tags/docker">docker</a></li><li><a class="label label-default" href="/tags/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9">インフラ</a></li></ul></div></div></header></div></div><div class="layout-content"><div class="container"><article><div class="layout-content__body"><div class="module-markdown">

<p>長めのansible-playbookをRUNしてる途中でエラーが出た時に役立ったので、まとめておく。</p>

<h3 id="どういう時に使う:f5fa53b0fb4decf6fe205e1fa30242da">どういう時に使う？</h3>

<p>例えば、<code>docker build</code>途中によくわからない理由でエラー落ちした時、
直前状態のコンテナに入ってデバッグしたい事がある。</p>

<p>ビルドに失敗した後、<code>docker ps -a</code>すると、
<code>Exited</code>したビルド作業用のコンテナが消されずに残っているので、
このコンテナの中にシェルで入れれば、エラーの詳細を調べられる。</p>

<blockquote>
<p>コンテナだけでなく、直近のイメージも残っているが、
Dockerコマンド単位でコミットされるため、
数珠つなぎのRUNとか、ansibleやchefなどのプロビジョニングツールを併用した時に、
大幅にロールバックしていることがある。</p>
</blockquote>

<h4 id="ビルド途中にエラーで落ちるdockerfileの例:f5fa53b0fb4decf6fe205e1fa30242da">ビルド途中にエラーで落ちるDockerfileの例</h4>

<pre><code class="language-docker">FROM busybox

RUN touch /step1
RUN touch /step2 &amp;&amp; errcmd &amp;&amp; touch /step3
RUN touch /step4
</code></pre>

<p><code>errcmd</code>という架空のコマンドで、わざとエラーを起こしてみる。</p>

<h4 id="docker-build-の途中で落ちる:f5fa53b0fb4decf6fe205e1fa30242da">docker build の途中で落ちる</h4>

<pre><code class="language-sh">$ docker build . -t tset

Sending build context to Docker daemon 2.048 kB
Sending build context to Docker daemon
Step 0 : FROM busybox
latest: Pulling from library/busybox
cfa753dfea5e: Pull complete
d7057cb02084: Pull complete
library/busybox:latest: The image you are pulling has been verified. Important: image verification is a tech preview feature and should not be relied on to provide security.
Digest: sha256:16a2a52884c2a9481ed267c2d46483eac7693b813a63132368ab098a71303f8a
Status: Downloaded newer image for busybox:latest
 ---&gt; d7057cb02084
Step 1 : RUN touch /step1
 ---&gt; Running in f1ca76c9072d
 ---&gt; ef649ff08895
Removing intermediate container f1ca76c9072d
Step 2 : RUN touch /step2 &amp;&amp; errcmd &amp;&amp; touch /step3
 ---&gt; Running in d117aa39bacd
/bin/sh: errcmd: not found
The command '/bin/sh -c touch /step2 &amp;&amp; errcmd &amp;&amp; touch /step3' returned a non-zero code: 127
</code></pre>

<p>途中にある<code>---&gt; Running in d117aa39bacd</code>の次で止まっている。</p>

<pre><code class="language-sh">$ docker ps -q --filter status=exited

d117aa39bacd
</code></pre>

<p><code>d117aa39bacd</code>コンテナが消されずに残っている。<br />
これが直近の作業コンテナで<code>touch /step2</code>までのコマンドを実行されているはず。</p>

<h4 id="exitedなコンテナには入れない:f5fa53b0fb4decf6fe205e1fa30242da">Exitedなコンテナには入れない？</h4>

<p>生きているコンテナであれば、<code>docker exec</code>+シェルでコンテナの中に入れるが、
Exitedしていると、以下の様なエラーが出る。</p>

<pre><code class="language-sh">$ docker exec -it d117aa39bacd sh

Error response from daemon: Container d117aa39bacd is not running
</code></pre>

<h3 id="解決手順:f5fa53b0fb4decf6fe205e1fa30242da">解決手順</h3>

<h4 id="１-exitedコンテナを一旦コミットして-イメージ化する:f5fa53b0fb4decf6fe205e1fa30242da">１．Exitedコンテナを一旦コミットして、イメージ化する</h4>

<p>死んでいるコンテナをコミットするという機会があまりなかったので、
ちょっと戸惑ったが、以下のコマンドでイメージ化できる。</p>

<pre><code class="language-sh">$ docker commit -t exited d117aa39bacd
</code></pre>

<h4 id="２-インタラクティブ-ttyモードで実行する:f5fa53b0fb4decf6fe205e1fa30242da">２．インタラクティブ+TTYモードで実行する</h4>

<p>そのまま<code>docker run</code>しても速攻で死ぬので、<code>-it bash</code>をつけて実行。</p>

<pre><code class="language-sh">$ docker run --rm -it exited sh
</code></pre>

<pre><code class="language-sh"># ls / | grep step
step1
step2
</code></pre>

<p>ちょっとまどろっこいが、一応エラーコマンド直前の状態のコンテナに入れた。
同じRUNコマンドの中でエラーが起きても、<code>touch /step2</code>までは実行されているようだ。</p>
</div></div><div class="layout-content__comment"><div class="module-comment"><div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'namikingsoft';
    var disqus_identifier = 'http:\/\/blog.namiking.net\/post\/2015\/09\/docker-exec-exited\/';
    var disqus_title = 'Dockerイメージのビルド中にExitedしたコンテナに入る方法';
    var disqus_url = 'http:\/\/blog.namiking.net\/post\/2015\/09\/docker-exec-exited\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div></article></div></div><div class="layout-pagenavi"><div class="container"><div class="layout-pagenavi__relate"><div class="module-relate"></div></div><div class="layout-pagenavi__paging"><div class="module-paging"><div class="module-paging__prev col-xs-6"></div><div class="module-paging__next col-xs-6"><a href="/post/2015/09/test-webpack-browser/" title="webpack-dev-serverで継続的なクライアントサイドテスト"><i class="fa fa-arrow-circle-o-right"></i><p class="hidden-xs">2015-09-11 (Fri)</p></a></div></div></div></div></div><div class="layout-sharenavi"><div class="container"><h4>この記事について</h4><div class="layout-sharenavi__profile"><div class="module-profile"><div class="module-profile__avatar"><img src="https://s.gravatar.com/avatar/3706c1a344dc2282c6683b6c6d0926f2?s=80&r=g"><small>書いた人<br>Written by</small></div><div class="module-profile__text"><h3>namikingsoft</h3><p>何かを残して逝きたい<br>フロントエンドエンジニア</p><ul><li><a href="#"><i class="fa fa-2x fa-user"></i></a></li><li><a href="#"><i class="fa fa-2x fa-github"></i></a></li><li><a href="#"><i class="fa fa-2x fa-twitter"></i></a></li></ul></div></div></div><div class="layout-sharenavi__sharelink"><div class="module-sharelink"><ul class="module-sharelink__list"><li class="module-sharelink__list-twitter"><a class="twitter-share-button" data-url="http://blog.namiking.net/post/2015/09/docker-exec-exited/" href="https://twitter.com/share" data-lang="ja" data-count="vertical" data-dnt="true">ツイート</a></li><li class="module-sharelink__list-facebook"><div class="fb-like" data-href="http://blog.namiking.net/post/2015/09/docker-exec-exited/" data-layout="box_count" data-action="like" data-show-faces="true" data-share="false"></div></li><li class="module-sharelink__list-google"><div class="g-plusone" data-href="http://blog.namiking.net/post/2015/09/docker-exec-exited/" data-size="tall"></div></li><li class="module-sharelink__list-hatena"><a class="hatena-bookmark-button" href="http://b.hatena.ne.jp/entry/http://blog.namiking.net/post/2015/09/docker-exec-exited/" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border:none;"></a></li><li class="module-sharelink__list-pocket"><a class="pocket-btn" data-save-url="http://blog.namiking.net/post/2015/09/docker-exec-exited/" data-pocket-label="pocket" data-pocket-count="vertical" data-lang="en"></a></li><li class="module-sharelink__list-line"><a href="http://line.me/R/msg/text/?http%3a%2f%2fblog.namiking.net%2fpost%2f2015%2f09%2fdocker-exec-exited%2f"><img src="/images/button/linebutton_36x60.png" width="36" height="60" alt="LINEに送る"></a></li></ul><div id="fb-root"></div></div></div></div></div><div class="layout-footer"><div class="container"><div class="layout-footer__poweredby col-sm-4"><div class="module-poweredby"><div class="module-poweredby__title"><a href="http://blog.namiking.net/"><strong>Namiking.net</strong><p>Web系エンジニアの技術ブログ</p></a></div><div class="module-poweredby__menu"><ul><li><a href="http://blog.namiking.net/"><i class="fa fa-lg fa-home"></i><span>HOME</span></a></li><li><a href="http://blog.namiking.net/about/"><i class="fa fa-lg fa-user"></i><span>ABOUT</span></a></li><li><a href="https://github.com/namikingsoft/"><i class="fa fa-lg fa-github"></i><span>GITHUB</span></a></li><li><a href="https://twitter.com/namikingsoft/"><i class="fa fa-lg fa-twitter"></i><span>TWITTER</span></a></li><li><a href="http://blog.namiking.net/index.xml"><i class="fa fa-lg fa-rss"></i><span>RSS</span></a></li></ul></div><div class="module-poweredby__hugo"><p>Designed &amp; Written by <a href="/about">@namikingsoft</a></p><p>Powered by <a href="http://gohugo.io">HUGO</a></p></div></div></div><div class="layout-footer__recent col-sm-4"><div class="module-recent"><h3>Recent Post</h3><dl><dt>2015-09-29 (Tue)</dt><dd><a href="http://blog.namiking.net/post/2015/09/docker-exec-exited/">Dockerイメージのビルド中にExitedしたコンテナに入る方法</a></dd><dt>2015-09-11 (Fri)</dt><dd><a href="http://blog.namiking.net/post/2015/09/test-webpack-browser/">webpack-dev-serverで継続的なクライアントサイドテスト</a></dd><dt>2015-09-04 (Fri)</dt><dd><a href="http://blog.namiking.net/post/2015/09/kanban-board/">オープンソースのかんばん式管理ツールを３つほど試してみた</a></dd><dt>2015-09-02 (Wed)</dt><dd><a href="http://blog.namiking.net/post/2015/09/install-docker-compose/">docker-composeのインストールとバージョン差異エラー回避方法</a></dd><dt>2015-09-01 (Tue)</dt><dd><a href="http://blog.namiking.net/post/2015/09/docker-taiga/">TAIGA on Dockerで本格アジャイル開発管理</a></dd></dl></div></div><div class="layout-footer__tagcloud col-sm-4"><div class="module-tagcloud"><h3>Tags</h3><ul><li><a href="/tags/docker">docker(5)</a></li><li><a href="/tags/docker-compose">docker-compose(1)</a></li><li><a href="/tags/libreboard">libreboard(1)</a></li><li><a href="/tags/mocha">mocha(1)</a></li><li><a href="/tags/oss">oss(4)</a></li><li><a href="/tags/restyaboard">restyaboard(2)</a></li><li><a href="/tags/taiga">taiga(2)</a></li><li><a href="/tags/webpack">webpack(1)</a></li><li><a href="/tags/webpack-dev-server">webpack-dev-server(1)</a></li><li><a href="/tags/wekan">wekan(2)</a></li><li><a href="/tags/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9">インフラ(2)</a></li><li><a href="/tags/%E3%82%B9%E3%82%AD%E3%83%AB%E3%82%B7%E3%83%BC%E3%83%88">スキルシート(1)</a></li></ul></div></div></div></div></body></html>